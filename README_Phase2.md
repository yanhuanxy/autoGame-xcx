# 游戏自动化系统 - Phase 2 完善版本

## 🎉 新功能亮点

### ✨ Phase 2 新增功能

- 🖥️ **PyQt6可视化模板创建工具**：用户友好的图形界面
- 📊 **增强的HTML执行报告**：美观的可视化报告
- 🔧 **实时图像匹配测试**：模板创建时即时验证
- 🧪 **完善的模板测试功能**：多种测试模式，确保模板质量
- 📋 **完善的任务管理**：可视化任务和步骤管理
- 🎨 **现代化UI设计**：符合Windows审美标准

## 项目概述

这是基于OCR和图像识别的小程序游戏自动化系统的第二个版本，在Phase 1核心功能基础上，增加了完整的可视化工具和增强的报告系统。

### 核心特性

- ✅ **可视化模板创建**：PyQt6图形界面，所见即所得的区域标记
- ✅ **智能图像匹配**：4种匹配算法，自动选择最佳方案
- ✅ **实时预览测试**：创建模板时即时测试匹配效果
- ✅ **完善的测试系统**：支持完整测试、单任务测试、匹配测试等多种模式
- ✅ **模拟运行模式**：安全的测试环境，不执行实际操作
- ✅ **增强执行报告**：HTML格式的详细可视化报告
- ✅ **完整的任务管理**：支持多任务、多步骤的复杂自动化流程
- ✅ **分辨率自适应**：自动处理不同分辨率下的坐标转换

## 技术架构

```
src/
├── template_creator_gui.py    # PyQt6可视化模板创建工具 ⭐ 新增
├── report_generator.py        # 增强的HTML报告生成器 ⭐ 新增
├── window_controller.py       # 窗口检测和控制
├── image_matcher.py           # 图像匹配算法
├── coordinate_converter.py    # 坐标转换
├── template_manager.py        # 模板管理
├── game_executor.py           # 执行引擎（已增强）
└── main.py                    # 主程序（已更新）

start_gui.py                   # GUI快速启动器 ⭐ 新增
```

## 环境要求

- **Python**: 3.13
- **操作系统**: Windows 10/11
- **微信客户端**: 最新版本
- **新增依赖**: PyQt6, scikit-image

## 安装步骤

1. **克隆项目**
```bash
git clone <repository-url>
cd autoGame-xcx
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **验证安装**
```bash
cd src
python process_main.py --test all
```

4. **启动GUI工具**
```bash
python start_gui.py
```

## 使用方法

### 🖥️ 1. 可视化模板创建（推荐）

```bash
# 方法1：使用快速启动器
python start_gui.py

# 方法2：使用主程序
cd src
python process_main.py --gui
```

#### GUI工具功能：
- **截取游戏界面**：一键截取微信游戏窗口
- **可视化标记**：鼠标拖拽选择操作区域
- **配置操作**：设置点击位置、匹配阈值等参数
- **实时测试**：即时测试图像匹配效果
- **任务管理**：支持多任务、多步骤管理
- **模板保存**：自动生成JSON模板和参考图像

### 📊 2. 增强的执行报告

执行模板后会自动生成：
- **HTML报告**：美观的可视化报告，包含详细统计信息
- **JSON报告**：结构化数据，便于程序处理
- **文本摘要**：简洁的执行结果概览

### 🔧 3. 命令行工具（保留）

```bash
cd src

# 运行完整测试
python process_main.py --test all

# 执行模板
python process_main.py --execute templates/your_template.json

# 列出所有模板
python process_main.py --list-templates

# 生成报告
python process_main.py --report reports/execution_report.json
```

## GUI工具使用指南

### 📋 创建模板的完整流程

1. **启动工具**
   ```bash
   python start_gui.py
   ```

2. **填写模板信息**
   - 输入模板名称（如：每日签到模板）
   - 输入游戏名称（如：某某小程序游戏）

3. **创建任务**
   - 输入任务名称（如：每日签到）
   - 点击"添加任务"

4. **截取游戏界面**
   - 确保微信和游戏已打开
   - 点击"截取游戏界面"

5. **标记操作区域**
   - 用鼠标拖拽选择要操作的按钮或区域
   - 在弹出的配置对话框中设置：
     - 区域名称（如：signin_button）
     - 操作类型（点击或仅验证）
     - 点击位置（如果是点击操作）
     - 匹配阈值（默认0.85）

6. **测试匹配效果**
   - 选中标记区域
   - 点击"测试"按钮验证匹配效果

7. **测试模板功能**
   - 选中标记区域，点击"测试"进行单区域测试
   - 点击"测试模板"进行完整模板测试
   - 支持多种测试模式：完整测试、单任务测试、匹配测试

8. **保存模板**
   - 点击"保存模板"
   - 模板和参考图像会自动保存

### 🎯 界面功能说明

#### 左侧面板：
- **截图显示区域**：显示游戏界面截图
- **区域标记**：绿色框显示已标记的区域
- **实时标记**：红色虚线框显示正在标记的区域

#### 右侧面板：
- **模板信息**：设置模板名称和游戏名称
- **任务管理**：添加和管理多个任务
- **标记区域列表**：显示当前任务的所有标记区域
- **全局设置**：设置重试次数和延迟时间

#### 菜单栏：
- **文件菜单**：新建、打开、保存模板
- **工具菜单**：测试窗口检测等实用工具

## 🧪 测试功能详解

### 1. **区域测试功能**
选中任意标记区域，点击"测试"按钮：
- **多算法测试**：同时使用4种匹配算法进行测试
- **详细结果显示**：显示每种算法的相似度分数
- **图像预览**：并排显示当前截图和参考图像
- **智能建议**：根据测试结果提供阈值调整建议

### 1.5. **高级匹配测试功能** ⭐ 新增
在区域配置对话框中点击"测试匹配"按钮：
- **算法选择**：可选择特定匹配算法（模板匹配、SSIM、特征匹配、混合匹配）
- **实时截图测试**：每次测试都重新截图，模拟真实使用场景
- **连续测试模式**：定时连续测试（每2秒），监控匹配稳定性
- **差异图像分析**：可视化显示当前图像与参考图像的差异
- **详细统计信息**：显示成功率、平均相似度、最高/最低相似度
- **智能阈值建议**：根据测试结果自动推荐最佳匹配阈值

### 2. **模板测试功能**
点击"测试模板"按钮，支持三种测试模式：

#### 🔄 完整测试模式
- 执行模板中的所有任务
- 支持模拟运行（不执行实际点击）
- 生成详细的执行报告
- 显示每个步骤的执行结果

#### 🎯 单任务测试模式
- 选择特定任务进行测试
- 快速验证单个任务的可行性
- 详细显示每个步骤的匹配结果
- 支持模拟运行模式

#### 🔍 匹配测试模式
- 仅测试图像匹配，不执行操作
- 快速验证所有区域的匹配效果
- 显示匹配成功率统计
- 识别潜在的匹配问题

### 3. **模拟运行模式**
- **安全测试**：不执行实际的鼠标点击操作
- **完整流程**：模拟完整的执行流程
- **实时反馈**：显示所有操作的模拟结果
- **调试友好**：便于调试和优化模板

### 4. **测试结果分析**
- **相似度分析**：显示每种算法的匹配相似度
- **成功率统计**：计算整体匹配成功率
- **错误诊断**：详细的错误信息和解决建议
- **性能指标**：显示执行时间和重试次数

## 🔍 高级匹配测试功能详解

### **匹配测试对话框功能**

#### 🎯 **测试配置选项**
- **匹配算法选择**：
  - `模板匹配`：快速精确，适合固定界面
  - `结构相似性(SSIM)`：光照鲁棒，适合亮度变化
  - `特征匹配`：形变鲁棒，适合界面缩放
  - `混合匹配`：智能选择，推荐使用
- **匹配阈值调节**：0.1-1.0，推荐0.85
- **测试次数设置**：1-10次，验证稳定性
- **实时截图开关**：模拟真实使用场景

#### 📊 **测试模式**
1. **单次测试**：执行指定次数的测试
2. **连续测试**：每2秒自动测试，监控动态变化
3. **差异分析**：实时显示图像差异

#### 🖼️ **图像预览功能**
- **当前截图**：实时显示截取的游戏区域
- **参考图像**：显示保存的模板图像
- **差异图像**：高亮显示两图像的差异部分

#### 📈 **测试结果分析**
- **实时日志**：彩色编码的测试过程记录
- **统计摘要**：成功率、平均相似度、最值统计
- **智能建议**：
  - 成功率 < 50%：建议重新标记区域
  - 成功率 50-80%：建议调整匹配阈值
  - 成功率 > 80%：测试结果良好

### **使用场景示例**

#### 🎮 **游戏按钮匹配测试**
```
测试场景：每日签到按钮
算法选择：混合匹配
测试结果：
  第1次测试 | 相似度: 0.923 | ✓ 匹配成功
  第2次测试 | 相似度: 0.918 | ✓ 匹配成功
  第3次测试 | 相似度: 0.925 | ✓ 匹配成功

测试摘要：
  成功率: 100% (3/3)
  平均相似度: 0.922
  建议: 测试结果良好！
```

#### 🔄 **连续测试监控**
适用于监控游戏界面的动态变化：
- 检测按钮状态变化
- 监控加载动画完成
- 验证界面稳定性

## 执行报告示例

### HTML报告特性：
- 📊 **执行摘要**：总任务数、成功率、执行时长
- 🖥️ **分辨率信息**：模板分辨率、当前分辨率、缩放比例
- 📝 **任务详情**：每个任务的执行步骤和结果
- 📈 **统计信息**：步骤成功率、平均相似度、重试次数
- 🎨 **现代化设计**：响应式布局、交互式展开/折叠

### 报告文件位置：
```
reports/
├── execution_report_20241217_143022.html  # HTML可视化报告
├── execution_report_20241217_143022.json  # JSON结构化数据
└── execution_report_20241217_143022.png   # 带标注的截图（如有）
```

## Phase 2 vs Phase 1 对比

| 功能 | Phase 1 | Phase 2 |
|------|---------|---------|
| 模板创建 | ❌ 手动编写JSON | ✅ 可视化GUI工具 |
| 用户界面 | ❌ 仅命令行 | ✅ 现代化GUI |
| 实时测试 | ❌ 无 | ✅ 多种测试模式 |
| 模拟运行 | ❌ 无 | ✅ 安全的模拟测试 |
| 执行报告 | ⚠️ 简单JSON | ✅ 美观HTML报告 |
| 区域标记 | ❌ 手动计算坐标 | ✅ 鼠标拖拽选择 |
| 任务管理 | ⚠️ 基础支持 | ✅ 完整可视化管理 |
| 错误处理 | ⚠️ 基础处理 | ✅ 完善的错误提示 |
| 测试反馈 | ❌ 无 | ✅ 详细测试结果分析 |

## 已知限制

### 当前版本限制：
- ⚠️ 仅支持Windows系统
- ⚠️ 需要微信客户端运行
- ⚠️ 图像识别受光照影响
- ⚠️ 极端分辨率差异可能影响准确性

### 计划改进：
- 🔄 更智能的游戏区域自动定位
- 🔄 支持更多图像匹配算法
- 🔄 批量模板创建功能
- 🔄 模板分享和导入优化

## 故障排除

### GUI启动问题：

1. **PyQt6未安装**
   ```bash
   pip install PyQt6
   ```

2. **依赖库缺失**
   ```bash
   pip install -r requirements.txt
   ```

3. **Python版本不兼容**
   - 确保使用Python 3.13

### 模板创建问题：

1. **无法截取游戏界面**
   - 确保微信已启动并显示游戏界面
   - 检查窗口是否被遮挡

2. **图像匹配失败**
   - 降低匹配阈值（如从0.85改为0.75）
   - 重新标记更清晰的区域
   - 确保游戏界面稳定（无动画）

3. **坐标不准确**
   - 确保截图时游戏界面完整显示
   - 避免在游戏界面变化时标记

## 下一步计划 (Phase 3)

1. **智能化增强**
   - AI辅助的游戏区域自动识别
   - 智能推荐最佳匹配算法
   - 自动优化匹配参数

2. **功能扩展**
   - 支持更多游戏类型
   - 批量模板处理
   - 模板市场和分享平台

3. **性能优化**
   - 多线程执行引擎
   - 内存使用优化
   - 执行速度提升

## 开发者信息

- **产品设计师**: Anna
- **Python开发工程师**: Noma
- **版本**: Phase 2 - 完善版本
- **更新时间**: 2024-12-17

## 联系方式

如有问题或建议，请及时反馈以便改进系统。

---

**🎉 Phase 2 版本现已完成，享受全新的可视化模板创建体验！**
